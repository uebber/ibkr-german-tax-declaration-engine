## FIFO Calculation Unit Test Specification (with RGL amounts)

This document outlines the test scenarios for the FIFO (First-In, First-Out) calculation engine. The tests are designed to cover a comprehensive range of valid input data, including common use cases and critical corner cases, as required for robust financial software. All tests will assume CSV file inputs and use the `ScenarioExpectedOutput` structure (and its components like `ExpectedRealizedGainLoss` and `ExpectedAssetEoyState`) for result verification. The `ExpectedRealizedGainLoss` structure must align with the `RealizedGainLoss` class defined in `src.domain.results.py`, including all current fields such as `realization_type`, `asset_category_at_realization`, `quantity_realized`, `total_cost_basis_eur`, `total_realization_value_eur`, etc. Currency conversion will mock 1 base currency unit = 2 EUR.

**Assumptions for Calculations:**
*   Commissions: 1 unit of the trade currency per trade (added to cost for buys/covers, subtracted from proceeds for sells/SSOs).
*   Currency Conversion: 1 Foreign Currency Unit = 2 EUR (mocked).
*   Gains/Losses are in EUR unless otherwise specified.
*   SOY Cost Basis: Sourced as per PRD 2.4 (historical FIFO first, then fallback to SOY report figures). The "Cost Basis Source" note applies to the cost/proceeds basis of the shares sold/covered from the SOY position.
*   Precision: Final gain/loss values are presented to two decimal places, consistent with `OUTPUT_PRECISION_AMOUNTS`.

**Legend for Trade Archetypes:**
*   `BL`: `TRADE_BUY_LONG`
*   `SL`: `TRADE_SELL_LONG`
*   `SSO`: `TRADE_SELL_SHORT_OPEN`
*   `BSC`: `TRADE_BUY_SHORT_COVER`
*   `HIST_`: Prefix for historical trades (before the current tax year).
*   `INTRA_`: Prefix for intra-tax year trades.
*   `(qty @ price)`: e.g., `BL (10 @ 100)` means Buy Long 10 shares at a price of 100.
*   `SOY_RPT(qty, cost)`: Data from `positions_start_of_year.csv`. `cost` is total cost basis money.
*   `EOY_RPT(qty)`: Data from `positions_end_of_year.csv`.

**Legend for Realization Types (in RGL column):**
*   `SOLD_LONG`: `RealizationType.LONG_POSITION_SALE`
*   `COV_SHORT`: `RealizationType.SHORT_POSITION_COVER`

---

### Test Group 1: Core FIFO Mechanics (Intra-Year Focus)
**Objective:** Verify fundamental FIFO logic for various trade sequences within the tax year.
**PRD Coverage:** 2.4 (FIFO Calculation), 5.7 (TradeEvent creation), 5.11 (Processing FinancialEvents).

| ID          | Description                                       | Inputs: `positions_start_of_year.csv` | Inputs: Historical Trades (Pre-SOY) | Inputs: Intra-Year `trades.csv` (`ASSET_X`)                        | Expected: RGLs (Type: Gain/Loss EUR) | Expected: `ASSET_X` EOY State (Qty) | Expected: Errors | Key Variations                                                                                               |
|-------------|---------------------------------------------------|---------------------------------------|-------------------------------------|--------------------------------------------------------------------|--------------------------------------|-----------------------------------|------------------|--------------------------------------------------------------------------------------------------------------|
| `CFM_L_001` | Basic Long: Buy then Sell All                     | Empty / Asset N/A                     | None                                | `BL (10 @ 100)`, `SL (10 @ 120)`                                   | 1: SOLD_LONG: +198.00                | 0                                 | 0                | EUR/USD (USD gain: +196.00), Commissions (Y/N), Different Qty/Price, Sell for Loss (e.g., SL(10@90) -> RGL: SOLD_LONG: -102.00) |
| `CFM_L_002` | Long: Buy then Sell Partial                       | Empty / Asset N/A                     | None                                | `BL (10 @ 100)`, `SL (5 @ 120)`                                    | 1: SOLD_LONG: +98.50                 | 5                                 | 0                | Sell remaining, EUR/USD, Commissions                                                                         |
| `CFM_L_003` | Long: Multiple Buys, Single Sell (covering first lot) | Empty / Asset N/A                     | None                                | `BL (10 @ 100)`, `BL (10 @ 110)`, `SL (10 @ 120)`                   | 1: SOLD_LONG: +198.00                | 10                                | 0                | EUR/USD, Commissions, Sell covers parts of multiple lots                                                     |
| `CFM_L_004` | Long: Multiple Buys, Multiple Sells               | Empty / Asset N/A                     | None                                | `BL (10@100)`, `BL (10@110)`, `SL (5@120)`, `SL (10@125)`         | 3: SOLD_LONG: +98.50, SOLD_LONG: +124.00, SOLD_LONG: +74.00 | 5                                 | 0                | Order of sells, covering different lots/parts                                                                |
| `CFM_S_001` | Basic Short: Sell Short then Buy Cover All        | Empty / Asset N/A                     | None                                | `SSO (10 @ 100)`, `BSC (10 @ 80)`                                  | 1: COV_SHORT: +198.00                | 0                                 | 0                | EUR/USD, Commissions, Different Qty/Price, Cover for Loss                                                    |
| `CFM_S_002` | Short: Sell Short then Buy Cover Partial          | Empty / Asset N/A                     | None                                | `SSO (10 @ 100)`, `BSC (5 @ 80)`                                   | 1: COV_SHORT: +98.50                 | -5                                | 0                | Cover remaining, EUR/USD, Commissions                                                                        |
| `CFM_S_003` | Short: Multiple SSOs, Single Cover                | Empty / Asset N/A                     | None                                | `SSO (10 @ 100)`, `SSO (10 @ 90)`, `BSC (10 @ 80)`                  | 1: COV_SHORT: +198.00                | -10                               | 0                | EUR/USD, Commissions, Cover parts of multiple lots                                                           |
| `CFM_S_004` | Short: Multiple SSOs, Multiple Covers             | Empty / Asset N/A                     | None                                | `SSO (10@100)`, `SSO (10@90)`, `BSC (5@80)`, `BSC (10@75)`         | 3: COV_SHORT: +98.50, COV_SHORT: +124.00, COV_SHORT: +74.00 | -5                                | 0                | Order of covers                                                                                              |
| `CFM_Z_001` | Zero Quantity Trade                               | Empty / Asset N/A                     | None                                | `BL (0 @ 100)`                                                     | 0: (None)                            | 0                                 | 0                | Should be handled gracefully (e.g. filtered or no financial impact)                                        |
| `CFM_M_001` | Mixed Assets (Long one, Short another)            | Empty / Asset N/A                     | None                                | `ASSET_X`: `BL(10@50), SL(10@60)`. `ASSET_Y`: `SSO(5@100), BSC(5@90)` | 2: SOLD_LONG: +98.00 (X), COV_SHORT: +48.00 (Y) | `X`:0, `Y`:0                    | 0                | Currencies, Commissions                                                                                      |

---

### Test Group 2: Start-of-Year (SOY) Position Handling
**Objective:** Verify correct establishment of SOY quantities and cost bases, considering historical trades and SOY report data, including fallback mechanisms and scenarios with incomplete historical logs.
**PRD Coverage:** 2.1 (SOY Quantity Precedence), 2.4 (SOY Cost Basis Determination), 5.10 (Initialize FIFO Ledgers).

| ID          | Description                                                                 | Inputs: `positions_start_of_year.csv` (`ASSET_A`) | Inputs: Historical Trades (Pre-SOY) (`ASSET_A`)     | Inputs: Intra-Year `trades.csv` (`ASSET_A`) | Expected: RGLs (Type: Gain/Loss EUR) (Cost Basis Source for SOY lot) | Expected: `ASSET_A` EOY State (Qty) | Expected: Errors | Key Variations                                                                                                |
|-------------|-----------------------------------------------------------------------------|---------------------------------------------------|-----------------------------------------------------|---------------------------------------------|----------------------------------------------------------------------|-----------------------------------|------------------|---------------------------------------------------------------------------------------------------------------|
| `SOY_R_001` | SOY Long from Report Only (No Hist.), Sell All                              | `SOY_RPT(10, 1000 EUR)`                           | None                                                | `SL (10 @ 120 EUR)`                         | 1: SOLD_LONG: +199.00 (From SOY Report)                              | 0                                 | 0                | Sell Partial, USD, Commissions, SOY Cost Basis Missing (if allowed by model, should use 0 or error)       |
| `SOY_R_002` | SOY Short from Report Only (No Hist.), Cover All                            | `SOY_RPT(-10, 1000 EUR proceeds)`                 | None                                                | `BSC (10 @ 80 EUR)`                         | 1: COV_SHORT: +199.00 (From SOY Report)                              | 0                                 | 0                | Cover Partial, USD, Commissions                                                                               |
| `SOY_H_001` | SOY Long: Provided Hist. Trades are sufficient to source cost basis for the *authoritative SOY_RPT quantity*. (This applies even if sum of *provided* hist. trades != SOY_RPT quantity, as long as hist. lots cover SOY_RPT quantity). | `SOY_RPT(10, ignored_cost)`                       | Example: `HIST_BL (15 @ 90 USD)` (sum=15, but SOY_RPT qty=10) | `SL (10 @ 120 USD)`                         | 1: SOLD_LONG: +596.67 (From *first 10 shares* of Hist. Trades @ 90 USD) | 0                                 | 0                | Multiple hist. buys. Exact match: `HIST_BL(10@90)`. SOY_RPT Qty < `sum(Hist Qty)`. USD.                  |
| `SOY_H_002` | SOY Short: Provided Hist. Trades are sufficient to source proceeds basis for the *authoritative SOY_RPT quantity*. (Applies even if abs(sum of *provided* hist. trades) != abs(SOY_RPT quantity), as long as hist. lots cover SOY_RPT quantity). | `SOY_RPT(-10, ignored_proceeds)`                  | Example: `HIST_SSO (15 @ 110 USD)` (sum=-15, but SOY_RPT qty=-10)| `BSC (10 @ 90 USD)`                         | 1: COV_SHORT: +396.67 (From *first 10 shares* of Hist. Trades @ 110 USD) | 0                                 | 0                | Multiple hist. SSOs. Exact match: `HIST_SSO(10@110)`. abs(SOY_RPT Qty) < abs(`sum(Hist Qty)`). USD.  |
| `SOY_F_001` | SOY Long Fallback: Hist. Insufficient (sum of *provided* hist. trades qty < SOY_RPT Qty), Sell All. Cost basis from SOY Report. | `SOY_RPT(20, 2000 USD)`                           | `HIST_BL (10 @ 90 USD)`                             | `SL (20 @ 120 USD)`                         | 1: SOLD_LONG: +798.00 (From SOY Report for *entire 20 shares*)   | 0                                 | 0                | Varying hist. start: `HIST_BL`, `HIST_BL -> HIST_SL (partial) -> HIST_BL`. |
| `SOY_F_002` | SOY Short Fallback: Hist. Insufficient (abs(sum of *provided* hist. trades qty) < abs(SOY_RPT Qty)), Cover All. Proceeds basis from SOY Report. | `SOY_RPT(-20, 2200 USD proceeds)`                 | `HIST_SSO (10 @ 110 USD)`                           | `BSC (20 @ 90 USD)`                         | 1: COV_SHORT: +798.00 (From SOY Report for *entire 20 shares*)   | 0                                 | 0                | Varying hist. start: `HIST_SSO`, `HIST_SSO -> HIST_BSC (partial) -> HIST_SSO`. |
| `SOY_F_003` | SOY Long Fallback: No Hist. Trades, Sell All                                | `SOY_RPT(10, 1000 USD)`                           | None                                                | `SL (10 @ 120 USD)`                         | 1: SOLD_LONG: +398.00 (From SOY Report)                          | 0                                 | 0                | -                                                                                                             |
| `SOY_N_001` | Asset Not in SOY Report, Intra-Year Buy then Sell                           | Empty for `ASSET_A`                               | None                                                | `BL (10 @ 100 EUR)`, `SL (10 @ 120 EUR)`    | 1: SOLD_LONG: +198.00                                            | 0                                 | 0                | Initial Qty must be 0.                                                                                        |
| `SOY_V_001` | SOY Long: Hist. BUY_LONG < SOY Qty (Fallback). Intra-year sells portion of SOY.         | `SOY_RPT(20, 2000 USD)`                           | `HIST_BL (10 @ 95 USD)`                             | `SL (15 @ 120 USD)`                         | 1: SOLD_LONG: +598.00 (From SOY Report for the 15 sold shares)   | 5                                 | 0                | Confirm cost basis of sold 15 shares uses SOY reported rate (100 USD/share).                                 |
| `SOY_V_002` | SOY Short: Hist. SELL_SHORT_OPEN < SOY Qty (Fallback). Intra-year covers portion.      | `SOY_RPT(-20, 2200 USD proceeds)`                 | `HIST_SSO (10 @ 105 USD)`                           | `BSC (15 @ 90 USD)`                         | 1: COV_SHORT: +598.00 (From SOY Report for the 15 covered shares)| -5                                | 0                | Confirm proceeds basis of covered 15 shares uses SOY reported rate (110 USD/share).                         |

---

### Test Group 3: End-of-Year (EOY) Position Validation
**Objective:** Ensure calculated EOY positions match `positions_end_of_year.csv` and that discrepancies (especially quantity) are flagged as errors.
**PRD Coverage:** 2.4 (EOY Quantity Validation), 2.10 (Critical Error Report: EOY Quantity Mismatch), 5.12 (Perform EOY Quantity Validation).

| ID          | Description                                                                 | Inputs: SOY (`ASSET_A`) | Inputs: Intra-Year (`ASSET_A`) | Inputs: `positions_end_of_year.csv` (`ASSET_A`) | Expected: RGLs (Type: Gain/Loss EUR) | Expected: `ASSET_A` EOY State (Qty) | Expected: Errors (`eoy_mismatch_error_count`) | Key Variations                                                      |
|-------------|-----------------------------------------------------------------------------|-------------------------|--------------------------------|-------------------------------------------------|--------------------------------------|-----------------------------------|-----------------------------------------------|-------------------------------------------------------------|
| `EOY_C_001` | Consistent EOY: SOY Empty -> Buy -> Sell Partial -> EOY matches             | Empty                   | `BL (20@10 EUR)`, `SL (5@12 EUR)`| `EOY_RPT(15)`                                   | 1: SOLD_LONG: +8.75                  | 15                                | 0                                             | USD, Commissions                                            |
| `EOY_C_002` | Consistent EOY: SOY Present -> Sell Partial -> EOY matches                  | `SOY_RPT(20, 200 EUR)`  | `SL (5@12 EUR)`                | `EOY_RPT(15)`                                   | 1: SOLD_LONG: +9.00                  | 15                                | 0                                             | USD, Commissions                                            |
| `EOY_C_003` | Consistent EOY: Calculated 0, Asset Missing in EOY Report                   | `SOY_RPT(10, 100 EUR)`  | `SL (10@12 EUR)`               | Empty for `ASSET_A`                             | 1: SOLD_LONG: +19.00                 | 0                                 | 0                                             | -                                                           |
| `EOY_M_001` | Mismatch: Calculated EOY > EOY Report Qty                                   | Empty                   | `BL (20@10 EUR)`               | `EOY_RPT(10)`                                   | 0: (None)                            | 20 (calculated)                   | 1                                             | Mismatch by different amounts                               |
| `EOY_M_002` | Mismatch: Calculated EOY < EOY Report Qty                                   | Empty                   | `BL (5@10 EUR)`                | `EOY_RPT(10)`                                   | 0: (None)                            | 5 (calculated)                    | 1                                             | -                                                           |
| `EOY_M_003` | Mismatch: Calculated EOY != 0, Asset Missing in EOY Report                  | Empty                   | `BL (10@10 EUR)`               | Empty for `ASSET_A`                             | 0: (None)                            | 10 (calculated)                   | 1                                             | -                                                           |
| `EOY_M_004` | Mismatch: Calculated EOY 0, Asset Present in EOY Report with Non-Zero Qty   | `SOY_RPT(10,100 EUR)`   | `SL (10@12 EUR)`               | `EOY_RPT(5)`                                    | 1: SOLD_LONG: +19.00                 | 0 (calculated)                    | 1                                             | -                                                           |
| `EOY_S_001` | Consistent EOY Short Position                                               | `SOY_RPT(-10, 1000 EUR)`| `BSC (5@90 EUR)`               | `EOY_RPT(-5)`                                   | 1: COV_SHORT: +49.00                 | -5                                | 0                                             | -                                                           |
| `EOY_SM_001`| Mismatch EOY Short: Calc -10, Report -5                                     | Empty                   | `SSO(10@100 EUR)`              | `EOY_RPT(-5)`                                   | 0: (None)                            | -10 (calculated)                  | 1                                             | -                                                           |

---

### Test Group 4: Multi-Year Data Handling
**Objective:** Test the system's ability to process historical trades spanning multiple years to correctly establish SOY lots for the current tax year.
**PRD Coverage:** 2.4 (Historical FIFO Calculation), Implicitly whole pipeline using long histories.

| ID          | Description                                                    | Inputs: Historical Trades (`ASSET_A`) (Relevant Years)                                | Inputs: SOY (`ASSET_A`) Tax Year (TY) | Inputs: Intra-Year (`ASSET_A`) (TY) | Expected: RGLs (Type: Gain/Loss EUR) (Cost Basis Source for SOY lot) | Expected: `ASSET_A` EOY State (Qty) (TY) | Expected: Errors | Key Variations                                                                |
|-------------|----------------------------------------------------------------|---------------------------------------------------------------------------------------|---------------------------------------|-------------------------------------|----------------------------------------------------------------------|------------------------------------------|------------------|-------------------------------------------------------------------------------|
| `MYH_L_001` | Deep History Long: Buys over TY-2, TY-1, Sold in TY            | TY-2: `BL(10@80 USD)`. TY-1: `BL(10@90 USD)`                                          | `SOY_RPT(20, ignored)`                | `SL(15@100 USD)`                    | 2: SOLD_LONG: +396.67, SOLD_LONG: +98.33 (From Hist. TY-2 & TY-1 lots) | 5                                        | 0                | Different number of historical years, more complex buy/sell patterns historically |
| `MYH_S_001` | Deep History Short: SSOs over TY-2, TY-1, Covered in TY        | TY-2: `SSO(10@120 USD)`. TY-1: `SSO(10@110 USD)`                                       | `SOY_RPT(-20, ignored)`               | `BSC(15@100 USD)`                   | 2: COV_SHORT: +396.67, COV_SHORT: +98.33 (From Hist. TY-2 & TY-1 lots) | -5                                       | 0                | -                                                                             |
| `MYH_P_001` | Deep History with Partial Sales Across Years                   | TY-3: `BL(20@70 USD)`. TY-2: `SL(5@80 USD)`. TY-1: `BL(10@90 USD)`                     | `SOY_RPT(25, ignored)`                | `SL(20@100 USD)`                    | 2: SOLD_LONG: +897.00, SOLD_LONG: +98.50 (From Hist. TY-3 & TY-1 lots) | 5                                        | 0                | More intricate partial sales and new buys in intervening years.               |

---

### Test Group 5: Complex Trade Sequences & Scenarios
**Objective:** Stress test FIFO logic with more intricate sequences and combinations of operations, ensuring robustness. Includes scenarios involving different trade types for an asset if rules permit (e.g., closing a long then opening a short).
**PRD Coverage:** 2.4, 5.7, 5.11.

| ID          | Description                                                                   | Inputs: SOY (`ASSET_A`)   | Inputs: Intra-Year (`ASSET_A`) (EUR)                                                          | Expected: RGLs (Type: Gain/Loss EUR) | Expected: EOY State (Qty) | Expected: Errors | Key Variations                                                                                     |
|-------------|-------------------------------------------------------------------------------|---------------------------|-----------------------------------------------------------------------------------------------|--------------------------------------|---------------------------|------------------|----------------------------------------------------------------------------------------------------|
| `CTX_LS_001`| Close Long then Open Short                                                    | `SOY_RPT(10,100 EUR)`     | `SL(10@120)` (closes SOY), `SSO(5@110)`, `BSC(5@100)`                                          | 2: SOLD_LONG: +199.00, COV_SHORT: +48.00 | 0                         | 0                | Start with SOY Short, cover, then open Long and sell. With/without commissions. (Corrected SOLD_LONG RGL from +1099 to +199) |
| `CTX_DT_001`| Day Trading Pattern (multiple buys/sells same day, ensure lot integrity)      | Empty                     | `BL(10@10, T09:00)`, `BL(10@11, T09:05)`, `SL(5@12, T09:10)`, `SL(10@13, T09:15)`           | 3: SOLD_LONG: +8.50, SOLD_LONG: +14.00, SOLD_LONG: +9.00 | 5                         | 0                | Vary order, more trades. Sorting of events for same day is crucial (PRD 5.8). Assume correct sort. |
| `CTX_LF_001`| Last Lot Full Consumption (sell exactly remaining shares from multiple buys)  | Empty                     | `BL(7@10)`, `BL(3@12)`, `SL(10@15)`                                                            | 2: SOLD_LONG: +33.30, SOLD_LONG: +7.70 | 0                         | 0                | (The RGLs represent consumption of each distinct acquisition lot by the single sale event)         |
| `CTX_SOYF_001`| SOY Position Full Consumption then New Intra-Year Position of Same Type     | `SOY_RPT(10, 1000 EUR)`   | `SL(10@120)` (closes SOY), `BL(5@125)`, `SL(3@130)`                                            | 2: SOLD_LONG: +199.00, SOLD_LONG: +13.40 | 2                         | 0                | Same for short positions.                                                                          |
| `CTX_SOYF_002`| SOY Position Partial Consumption then New Intra-Year Buys then More Sells | `SOY_RPT(20, 2000 EUR)`   | `SL(5@110)` (partial SOY), `BL(10@115)`, `SL(15@120)` (sells rest of SOY)                     | 2: SOLD_LONG: +49.00, SOLD_LONG: +299.00 | 10 (L_intra)              | 0                | (The `SL(15@120)` is interpreted as selling the remaining 15 SOY shares based on qty)              |

---
### Test Group 6: Tax Reporting Aggregation & Loss Offsetting Logic
*Revision 2025-05-18 – Aligned with PRD §2.7 (Gross Reporting for Forms) and §2.8 (Conceptual Net Summaries with Configurable Derivative Loss Capping). This revision also introduces `conceptual_fund_income_net_taxable` and specific test cases for fund income handling (LO_FUND_001, LO_FUND_002).*

**Objective**
Verify:
1.  Correct aggregation of **gross gains and gross losses** into categories for direct entry onto German tax forms (Anlage KAP, Anlage SO), as per PRD §2.7. Specifically, KAP lines for Stocks and Derivatives require separate gross gains and gross losses; Other Capital Income lines require separate gross positive and gross negative components. Derivative losses for KAP Zeile 24 are reported gross, un-capped.
2.  Correct calculation of **conceptual net balances per tax pot** (Stocks, Derivatives, Other Capital Income, §23 EStG, and Investment Funds) for user information. For the Derivatives pot, this includes testing with the €20,000 loss limitation cap **ON** and **OFF** (simulating a configurable behavior for the conceptual summary part of the tool's output).
3.  Ensure that **net taxable income from investment funds** is correctly isolated and reported conceptually, and crucially, is **NOT** included in Anlage KAP Zeile 19 or the conceptual "Other Capital Income" pot (as it's declared via Anlage KAP-INV).

**Key Principles based on PRD for this Test Specification:**
*   **Form Line Reporting (Anlage KAP, SO):**
    *   Stocks (KAP Z.20/23): Gross Gains reported on Z.20, Gross (absolute) Losses on Z.23.
    *   Derivatives (KAP Z.21/24): Gross Gains on Z.21, Gross (absolute) Losses on Z.24 (always un-capped for form).
    *   Other Capital Income (KAP Z.19/22): Gross positive **non‑fund** components contribute to Z.19; gross (absolute) **non‑fund** negative components are reported on Z.22. Fund distributions and fund sale gains/losses are declared on KAP‑INV and are **not** part of these `kap_other_income_positive` / `kap_other_losses_abs` components (PRD §2.7). These components must solely reflect income/losses realized within the current tax year.
    *   §23 EStG (Anlage SO Z.54): Net G/L reported.
*   **Conceptual Net Summaries (User Info):**
    *   Stocks: Net of gross gains and gross losses.
    *   Derivatives: Net of gross gains and gross losses. This net loss can be shown conceptually with the €20k cap applied (if loss) OR un-capped.
    *   Other Capital Income: Net of gross positive and gross negative **non-fund** components (`sonst_g - sonst_v`).
    *   Investment Funds: Net taxable income from funds (after Teilfreistellung).
    *   §23 EStG: Net of gross gains and gross losses.

---
#### Input dictionary (`InputGrossPotComponents`)
Contains gross aggregates for each category before any offsetting between pots. Losses (`_v` keys) are positive `Decimal`s representing the absolute loss amount. For tests involving fund income (e.g., LO_FUND_001), the `InputGrossPotComponents` will define the non-fund elements, and the test setup will separately simulate the generation of a specific `fund_income_net_taxable` amount through fund-related RGLs or events.
| Key       | Description                                                                   |
|-----------|-------------------------------------------------------------------------------|
| `akt_g`   | Gross gains from stocks (positive `Decimal`)                                  |
| `akt_v`   | Gross losses from stocks (positive `Decimal`, absolute value)                 |
| `term_g`  | Gross gains from derivatives / Termingeschäfte (positive)                     |
| `term_v`  | Gross losses from derivatives / Termingeschäfte (positive, absolute value)    |
| `sonst_g` | Gross positive *non‑fund* "Other Capital Income" (interest, non‑fund dividends, bond gains, positive Stückzinsen) |
| `sonst_v` | Gross (absolute) *non‑fund* "Other Capital Income" losses (bond losses, negative Stückzinsen) |
| `p23_g`   | Gross gains from §23 EStG transactions (positive)                             |
| `p23_v`   | Gross losses from §23 EStG transactions (positive, absolute value)            |

---
#### Output dictionary (`ExpectedReportingAndSummaries`)
| Key                                   | Maps to form / Concept                                       | Meaning                                                                      |
|---------------------------------------|--------------------------------------------------------------|------------------------------------------------------------------------------|
| `form_kap_z19_auslaendische_net`             | KAP Zeile 19                                                 | Net foreign capital income from stocks, derivatives, and other non-fund sources (`akt_g + term_g + sonst_g – akt_v – sonst_v`, derivative losses `term_v` are not subtracted). Crucially, does **not** include fund income. |
| `form_kap_z20_aktien_g`               | KAP Zeile 20                                                 | Gross stock gains (`akt_g`)                                                  |
| `form_kap_z21_derivate_g`             | KAP Zeile 21                                                 | Gross derivative gains (`term_g`)                                            |
| `form_kap_z22_sonstige_v`             | KAP Zeile 22                                                 | Gross (absolute) "Other Capital Income" losses (non-fund, `sonst_v`)       |
| `form_kap_z23_aktien_v`               | KAP Zeile 23                                                 | Gross (absolute) stock losses (`akt_v`)                                      |
| `form_kap_z24_derivate_v`             | KAP Zeile 24                                                 | Gross (absolute) derivative losses (`term_v`, always un-capped for form)     |
| `form_so_z54_p23_net_gv`              | Anlage SO Zeile 54                                           | Net §23 EStG G/L (`p23_g - p23_v`)                                           |
| `conceptual_net_other_income`         | Conceptual Summary                                           | Net Other Capital Income (non-fund, `sonst_g - sonst_v`)                     |
| `conceptual_net_stocks`               | Conceptual Summary                                           | Net Stock G/L (`akt_g - akt_v`)                                              |
| `conceptual_net_derivatives_uncapped` | Conceptual Summary (Derivative Cap OFF)                      | Net Derivative G/L (`term_g - term_v`), no €20k cap applied                  |
| `conceptual_net_derivatives_capped`   | Conceptual Summary (Derivative Cap ON for net losses)        | Net Derivative G/L; if net loss, capped at max loss of €20,000               |
| `conceptual_net_p23_estg`             | Conceptual Summary                                           | Net §23 EStG G/L (`p23_g - p23_v`, same as `form_so_z54_p23_net_gv`)        |
| `conceptual_fund_income_net_taxable`  | Conceptual Summary                                           | Net taxable fund income (after Teilfreistellung). This is a separate conceptual pot. |

---
#### Test matrix (updated for PRD v3.2.3 and fund income tests)
`D("…")` = `Decimal`. All unspecified input components are `D("0")`.
Expected output amounts are to two decimal places (matching `OUTPUT_PRECISION_AMOUNTS`).
*For `LO_FUND_*` tests, the `InputGrossPotComponents` defines non-fund items. An additional `fund_income_net_taxable` is simulated as described in the test ID.*

| ID | Description | `InputGrossPotComponents` | `ExpectedReportingAndSummaries` |
|----|-------------|---------------------------|---------------------------------|
| `LO_ALL_001` | All pots zero | `{ 'akt_g': D("0"), 'akt_v': D("0"), 'term_g': D("0"), 'term_v': D("0"), 'sonst_g': D("0"), 'sonst_v': D("0"), 'p23_g': D("0"), 'p23_v': D("0") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_AKT_001` | Stocks – gains only | `{ 'akt_g': D("1000") }` | `{ 'form_kap_z19_auslaendische_net': D("1000.00"), 'form_kap_z20_aktien_g': D("1000.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("1000.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_AKT_002` | Stocks – losses only | `{ 'akt_v': D("1000") }` | `{ 'form_kap_z19_auslaendische_net': D("-1000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("1000.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("-1000.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_AKT_003` | Stocks – gains > losses | `{ 'akt_g': D("1000"), 'akt_v': D("200") }` | `{ 'form_kap_z19_auslaendische_net': D("800.00"), 'form_kap_z20_aktien_g': D("1000.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("200.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("800.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_AKT_004` | Stocks – losses > gains | `{ 'akt_g': D("200"), 'akt_v': D("1000") }` | `{ 'form_kap_z19_auslaendische_net': D("-800.00"), 'form_kap_z20_aktien_g': D("200.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("1000.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("-800.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_AKT_005` | Stocks – gains = losses | `{ 'akt_g': D("1000"), 'akt_v': D("1000") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("1000.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("1000.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_001` | Derivatives – gains only | `{ 'term_g': D("5000") }` | `{ 'form_kap_z19_auslaendische_net': D("5000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("5000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("5000.00"), 'conceptual_net_derivatives_capped': D("5000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_002` | Derivatives – losses only (< 20k) | `{ 'term_v': D("15000") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("15000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("-15000.00"), 'conceptual_net_derivatives_capped': D("-15000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_003` | Derivatives – losses = 20k | `{ 'term_v': D("20000") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("20000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("-20000.00"), 'conceptual_net_derivatives_capped': D("-20000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_004` | Derivatives – losses > 20k | `{ 'term_v': D("30000") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("30000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("-30000.00"), 'conceptual_net_derivatives_capped': D("-20000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_005` | Derivatives – gains > losses | `{ 'term_g': D("25000"), 'term_v': D("5000") }` | `{ 'form_kap_z19_auslaendische_net': D("25000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("25000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("5000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("20000.00"), 'conceptual_net_derivatives_capped': D("20000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_006` | Derivatives – losses > gains (net loss < 20k) | `{ 'term_g': D("5000"), 'term_v': D("15000") }` | `{ 'form_kap_z19_auslaendische_net': D("5000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("5000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("15000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("-10000.00"), 'conceptual_net_derivatives_capped': D("-10000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_007` | Derivatives – losses > gains (net loss > 20k) | `{ 'term_g': D("5000"), 'term_v': D("30000") }` | `{ 'form_kap_z19_auslaendische_net': D("5000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("5000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("30000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("-25000.00"), 'conceptual_net_derivatives_capped': D("-20000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_008` | Derivatives – gains > losses (loss batch > 20k) | `{ 'term_g': D("40000"), 'term_v': D("25000") }` | `{ 'form_kap_z19_auslaendische_net': D("40000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("40000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("25000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("15000.00"), 'conceptual_net_derivatives_capped': D("15000.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_TERM_009` | Derivatives – gains = losses | `{ 'term_g': D("10000"), 'term_v': D("10000") }` | `{ 'form_kap_z19_auslaendische_net': D("10000.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("10000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("10000.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SONST_001` | Other – gains only | `{ 'sonst_g': D("700") }` | `{ 'form_kap_z19_auslaendische_net': D("700.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("700.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SONST_002` | Other – losses only | `{ 'sonst_v': D("700") }` | `{ 'form_kap_z19_auslaendische_net': D("-700.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("700.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("-700.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SONST_003` | Other – gains > losses | `{ 'sonst_g': D("700"), 'sonst_v': D("100") }` | `{ 'form_kap_z19_auslaendische_net': D("600.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("100.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("600.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SONST_004` | Other – losses > gains | `{ 'sonst_g': D("100"), 'sonst_v': D("700") }` | `{ 'form_kap_z19_auslaendische_net': D("-600.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("700.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("-600.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_P23_001` | §23 – gains only | `{ 'p23_g': D("1200") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("1200.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("1200.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_P23_002` | §23 – losses only | `{ 'p23_v': D("1200") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("-1200.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("-1200.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_P23_003` | §23 – gains > losses | `{ 'p23_g': D("1200"), 'p23_v': D("300") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("900.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("900.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_P23_004` | §23 – losses > gains | `{ 'p23_g': D("300"), 'p23_v': D("1200") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("-900.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("-900.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_MIX_001` | All pots active, Term net loss < 20k | `{ 'akt_g': D("2000"), 'akt_v': D("500"), 'term_g': D("3000"), 'term_v': D("4000"), 'sonst_g': D("1000"), 'sonst_v': D("1500"), 'p23_g': D("800"), 'p23_v': D("200") }` | `{ 'form_kap_z19_auslaendische_net': D("4000.00"), 'form_kap_z20_aktien_g': D("2000.00"), 'form_kap_z21_derivate_g': D("3000.00"), 'form_kap_z22_sonstige_v': D("1500.00"), 'form_kap_z23_aktien_v': D("500.00"), 'form_kap_z24_derivate_v': D("4000.00"), 'form_so_z54_p23_net_gv': D("600.00"), 'conceptual_net_other_income': D("-500.00"), 'conceptual_net_stocks': D("1500.00"), 'conceptual_net_derivatives_uncapped': D("-1000.00"), 'conceptual_net_derivatives_capped': D("-1000.00"), 'conceptual_net_p23_estg': D("600.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_MIX_002` | All pots active, Term net loss > 20k | `{ 'akt_g': D("500"), 'akt_v': D("2000"), 'term_g': D("1000"), 'term_v': D("30000"), 'sonst_g': D("1500"), 'sonst_v': D("500"), 'p23_g': D("200"), 'p23_v': D("800") }` | `{ 'form_kap_z19_auslaendische_net': D("500.00"), 'form_kap_z20_aktien_g': D("500.00"), 'form_kap_z21_derivate_g': D("1000.00"), 'form_kap_z22_sonstige_v': D("500.00"), 'form_kap_z23_aktien_v': D("2000.00"), 'form_kap_z24_derivate_v': D("30000.00"), 'form_so_z54_p23_net_gv': D("-600.00"), 'conceptual_net_other_income': D("1000.00"), 'conceptual_net_stocks': D("-1500.00"), 'conceptual_net_derivatives_uncapped': D("-29000.00"), 'conceptual_net_derivatives_capped': D("-20000.00"), 'conceptual_net_p23_estg': D("-600.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_MIX_003` | All pots generate gains | `{ 'akt_g': D("1000"), 'term_g': D("2000"), 'sonst_g': D("500"), 'p23_g': D("300") }` | `{ 'form_kap_z19_auslaendische_net': D("3500.00"), 'form_kap_z20_aktien_g': D("1000.00"), 'form_kap_z21_derivate_g': D("2000.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("300.00"), 'conceptual_net_other_income': D("500.00"), 'conceptual_net_stocks': D("1000.00"), 'conceptual_net_derivatives_uncapped': D("2000.00"), 'conceptual_net_derivatives_capped': D("2000.00"), 'conceptual_net_p23_estg': D("300.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_MIX_004` | All pots report losses | `{ 'akt_v': D("1000"), 'term_v': D("25000"), 'sonst_v': D("500"), 'p23_v': D("300") }` | `{ 'form_kap_z19_auslaendische_net': D("-1500.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("500.00"), 'form_kap_z23_aktien_v': D("1000.00"), 'form_kap_z24_derivate_v': D("25000.00"), 'form_so_z54_p23_net_gv': D("-300.00"), 'conceptual_net_other_income': D("-500.00"), 'conceptual_net_stocks': D("-1000.00"), 'conceptual_net_derivatives_uncapped': D("-25000.00"), 'conceptual_net_derivatives_capped': D("-20000.00"), 'conceptual_net_p23_estg': D("-300.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SFILT_G_001` | `sonst_g`: Historical positive events only (e.g., Div 100 TY-1, Int 50 TY-1). Current year `sonst_g` should be 0. | `{ 'sonst_g': D("0") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SFILT_G_002` | `sonst_g`: Mix of historical (Div 100 TY-1) and current tax year (Div 200 TY, Int 75 TY). Current year `sonst_g` should be 275.00. | `{ 'sonst_g': D("275.00") }` | `{ 'form_kap_z19_auslaendische_net': D("275.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("275.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SFILT_V_001` | `sonst_v`: Historical negative events only (e.g., Bond Loss 100 TY-1). Current year `sonst_v` should be 0. | `{ 'sonst_v': D("0") }` | `{ 'form_kap_z19_auslaendische_net': D("0.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("0.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SFILT_V_002` | `sonst_v`: Mix of historical (Bond Loss 100 TY-1) and current tax year (Bond Loss 150 TY). Current year `sonst_v` should be 150.00. | `{ 'sonst_v': D("150.00") }` | `{ 'form_kap_z19_auslaendische_net': D("-150.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("150.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("-150.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_SFILT_GV_001`| `sonst_g`/`v`: Mixed historical (Div 50 TY-1, Loss 20 TY-1) and current tax year (Div 100 TY, Loss 30 TY) events. Current year `sonst_g`=100.00, `sonst_v`=30.00. | `{ 'sonst_g': D("100.00"), 'sonst_v': D("30.00") }` | `{ 'form_kap_z19_auslaendische_net': D("70.00"), 'form_kap_z20_aktien_g': D("0.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("30.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("70.00"), 'conceptual_net_stocks': D("0.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("0.00") }` |
| `LO_FUND_001` | Fund Income Present (Net +200). Test Z.19 exclusion. Other KAP income: Aktien Gain 100, Sonstige Gain 50. | `{ 'akt_g': D("100"), 'sonst_g': D("50") }` (*Simulated for test code: fund_income_net_taxable = D("200.00")*) | `{ 'form_kap_z19_auslaendische_net': D("150.00"), 'form_kap_z20_aktien_g': D("100.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("50.00"), 'conceptual_net_stocks': D("100.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("200.00") }` |
| `LO_FUND_002` | Fund Loss Present (Net -60). Test Z.19 exclusion. Other KAP income: Aktien Gain 100, Sonstige Gain 50. | `{ 'akt_g': D("100"), 'sonst_g': D("50") }` (*Simulated for test code: fund_income_net_taxable = D("-60.00")*) | `{ 'form_kap_z19_auslaendische_net': D("150.00"), 'form_kap_z20_aktien_g': D("100.00"), 'form_kap_z21_derivate_g': D("0.00"), 'form_kap_z22_sonstige_v': D("0.00"), 'form_kap_z23_aktien_v': D("0.00"), 'form_kap_z24_derivate_v': D("0.00"), 'form_so_z54_p23_net_gv': D("0.00"), 'conceptual_net_other_income': D("50.00"), 'conceptual_net_stocks': D("100.00"), 'conceptual_net_derivatives_uncapped': D("0.00"), 'conceptual_net_derivatives_capped': D("0.00"), 'conceptual_net_p23_estg': D("0.00"), 'conceptual_fund_income_net_taxable': D("-60.00") }` |

---
**Implementation hint for Tax Engine:**
The `LossOffsettingEngine` should distinguish between:
1.  **Figures for Form Declaration:** These must be the gross, un-capped amounts for Anlage KAP lines 19-24, and the net G/L for Anlage SO Zeile 54, as detailed in PRD §2.7 and reflected in the `form_...` expected values.
2.  **Conceptual Net Summaries:** For user information or internal logging, the engine can calculate net results for each tax pot. For the derivatives pot, this net loss summary should be available both un-capped and capped at €20,000. Investment fund income (net taxable) should form its own conceptual pot, separate from "Other Capital Income."

The Finanzamt applies the actual offsetting rules and loss limitations based on the declared gross figures on the tax forms.
**Note on potential bug:** The current implementation of `LossOffsettingEngine` in `loss_offsetting.py` (as of the associated problem description) may incorrectly add `fund_income_net_taxable` to the components used for KAP Zeile 19 (`kap_other_income_positive` / `kap_other_losses_abs`) and consequently to `conceptual_net_other_income`. Test cases `LO_FUND_001` and `LO_FUND_002` are specifically designed to assert the PRD-correct behavior (i.e., exclusion of fund income from these general KAP pots) and will fail if this bug is present, thereby highlighting the discrepancy.
